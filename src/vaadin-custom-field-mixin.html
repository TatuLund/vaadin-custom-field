<script>
  /**
   * @namespace Vaadin
   */
  window.Vaadin = window.Vaadin || {};

  /**
  * @polymerMixin
  * @memberof Vaadin
  */
  Vaadin.CustomFieldMixin = superClass => class VaadinCustomFieldMixin extends superClass {
    static get properties() {
      return {
        /**
         * Array of available input nodes
         */
        __inputs: {
          type: Array,
          value: []
        },

        /**
         * The object used to localize this component.
         * To change the default localization, replace the entire
         * _i18n_ object or just the property you want to modify.
         *
         * The object has the following JSON structure:

           {
             // A function to format given `Array` as
             // component value. Array is list of all internal values
             // in the order of their presense in the DOM
             // This function is called each time the internal input
             // value is changed.
             formatValue: inputValues => {
               // returns a value representation of the given
               // array of values
             },

             // A function to parse the given value to an `Array` in the format
             // of the list of all internal values
             // in the order of their presence in the DOM
             // This function is called when value of the
             // custom field is set.
             parseValue: value => {
               // returns the array of values from parsed value string.
             }
          */
        i18n: {
          type: Object,
          value: () => {
            return {
              parseValue: function(value) {
                return value.split(' ');
              },
              formatValue: function(inputValues) {
                return inputValues.join(' ');
              }
            };
          }
        },

        __errorId: String,
        __labelId: String
      };
    }

    ready() {
      super.ready();

      this.__boundUpdateValue = this.__updateValue.bind(this);

      this.$.slot.addEventListener('slotchange', e =>
        this.__setInputsFromNodes(e.target.assignedNodes()));

      this.__setInputsFromNodes(this.childNodes);

      var uniqueId = Vaadin.CustomFieldMixin._uniqueId = 1 + Vaadin.CustomFieldMixin._uniqueId || 1;
      this.__errorId = `${this.constructor.is}-error-${uniqueId}`;
      this.__labelId = `${this.constructor.is}-label-${uniqueId}`;
    }

    __updateValue(e) {
      // Stop native change events
      e && e.stopPropagation();

      this.validate();
      this.__setValue();
      this.dispatchEvent(new CustomEvent('change', {
        bubbles: true,
        cancelable: false,
        detail: {
          value: this.value
        }
      }));
    }

    __setValue() {
      this.__settingValue = true;
      this.value = this.i18n.formatValue.apply(this, [this.inputs.map(input => input.value)]);
      this.__settingValue = false;
    }

    __setInputsFromNodes(nodes) {
      const inputs = Array.from(nodes).filter(node => node.validate || node.checkValidity);

      const addedInputs = inputs.filter(node => this.__inputs.indexOf(node) < 0);
      const removedInputs = this.__inputs.filter(node => inputs.indexOf(node) < 0);

      addedInputs.forEach(input => input.addEventListener('change', this.__boundUpdateValue));
      this.__inputs = this.__inputs.concat(addedInputs);

      removedInputs.forEach(input => input.removeEventListener('change', this.__boundUpdateValue));
      this.__inputs = this.__inputs.filter(input => removedInputs.indexOf(input) < 0);

      this.__setValue();
    }

    __valueChanged(value, oldValue) {
      if (this.__settingValue || !this.inputs) {
        return;
      }

      const valuesArray = this.i18n.parseValue(value);
      if (!valuesArray || valuesArray.length == 0) {
        console.warn('Value parser has not provided values array');
        return;
      }

      this.inputs.forEach((input, id) => input.value = valuesArray[id]);
      if (oldValue !== undefined) {
        this.validate();
      }
    }

    get inputs() {
      return this.__inputs;
    }
  };
</script>
